<script src='./wc-i18n.js'></script>
<script>
  // Object.assign polyfill 
  if (typeof Object.assign != 'function') {
    (function () {
      Object.assign = function (target) {
        'use strict';
        // We must check against these specific cases.
        if (target === undefined || target === null) {
          throw new TypeError('Cannot convert undefined or null to object');
        }

        var output = Object(target);
        for (var index = 1; index < arguments.length; index++) {
          var source = arguments[index];
          if (source !== undefined && source !== null) {
            for (var nextKey in source) {
              if (source.hasOwnProperty(nextKey)) {
                output[nextKey] = source[nextKey];
              }
            }
          }
        }
        return output;
      };
    })();
  }
  (function(window) {
    var _instances = {};
    var _WCI18n = window.WCI18n;
    var _computeLocaleURI = function(localeDir, domain, locale) {
      return localeDir + '/' + (domain != 'default' ? domain + '_' : '') + locale + '.json';
    };

    window.WCI18n = function(namespace, locales) {
      var _i18nInstance = _WCI18n(namespace, locales);
      var proto = {
        properties: {
          _i18n: {
            type: Object,
            value: function() { return {}; }
          }
        },
        ready: function() {
          this.updateI18n();
        },
        updateI18n: function (lang) {
          var locale = window.WCI18n.getLocale();
          _i18nInstance.getLocales(lang)
            .catch(function(err) {
              return this._fetchCurrentLocaleStrings();
            }.bind(this))
            .then(function(i18nObj) {
              this._i18n = i18nObj;
            }.bind(this))
        },
        _fetchCurrentLocaleStrings: function() {
          var _localePromise = this._getLocalesRaw();
          if (_localePromise) return _localePromise;
          
          var locale = window.WCI18n.getLocale();
          var url = _computeLocaleURI(this.resolveUrl('./locales'), namespace, locale);
          var promise = fetch(url).then(function(res) {
            return res.json();
          })
          // Assign promise to data location to prevent duplicate
          // requests
          _i18nInstance.setLocales(locale, promise);
          return promise.then(function(locales) {
            // Assign actual data for future requesters of these locales
            _i18nInstance.setLocales(locale, locales);
            return locales;
          });
        },
        attached: function() {
          if (!Array.isArray(_instances[namespace])) _instances[namespace] = [];
          _instances[namespace].push(this);
        },
        detached: function() {
          _instances[namespace] = _instances[namespace].filter(function(instance) {
            return instance !== this;
          }.bind(this));
        }
      };
      // Merge the existing methods from the object
      // returned from _WCI18n with the Polymer proto
      Object.assign(_i18nInstance, proto);
      return _i18nInstance;
    };

    // Ensure that we get the getLocale/setLocale
    // methods from the original WCI18n method
    Object.assign(window.WCI18n, _WCI18n);
    window.WCI18n.setLocale = function(val) {
      _WCI18n.setLocale(val);
      Object.keys(_instances)
        .map(function(namespace) {
          return _instances[namespace];
        })
        .reduce(function(target, source) {
          if (!Array.isArray(target)) target = [];
          if (!Array.isArray(source)) source = [];
          return target.concat(source);
        })
        .forEach(function(instance) {
          instance.updateI18n();
        });
    };

  })(window);
</script>